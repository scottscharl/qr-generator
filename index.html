<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  </head>
  <body class="bg-gray-900 min-h-screen p-4 sm:p-6 lg:p-8">
    <main class="max-w-4xl mx-auto">
      <h1 class="text-3xl sm:text-4xl font-bold text-white mb-6 sm:mb-8">
        Scott's QR Code Generator
      </h1>

      <!-- Form Card -->
      <div class="bg-gray-800 rounded-lg shadow-xl p-4 sm:p-6 mb-6 sm:mb-8">
        <form id="generatorForm">
          <label class="block text-sm font-medium text-gray-300 mb-2">
            Enter some text:
          </label>
          <input
            type="text"
            id="textInput"
            placeholder="https://example.com"
            required
            autofocus
            class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4"
          />
          <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <button
              type="submit"
              id="submitBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed"
            >
              Generate
              <span
                class="text-xs ml-1 px-1.5 py-0.5 border border-white/30 rounded"
                >ENTER</span
              >
            </button>
            <button
              type="button"
              id="clearButton"
              class="bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-md transition-colors"
            >
              Clear
            </button>
          </div>
        </form>
      </div>

      <!-- QR Code Container -->
      <div id="qrContainer" class="space-y-4"></div>

      <!-- Modal -->
      <dialog
        id="qrModal"
        class="backdrop:bg-black backdrop:bg-opacity-75 rounded-lg shadow-xl p-0 max-w-md w-full bg-transparent"
      >
        <div class="bg-gray-800 rounded-lg">
          <div
            class="flex items-center justify-between p-4 border-b border-gray-700"
          >
            <h3 class="text-xl font-semibold text-white">QR Code</h3>
            <button
              id="closeModal"
              class="text-gray-400 hover:text-gray-200 text-2xl leading-none"
            >
              Ã—
            </button>
          </div>
          <div id="modalContent" class="p-6 bg-white flex justify-center"></div>
          <div class="p-4 border-t border-gray-700 space-y-2">
            <button
              id="downloadBtn"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors"
            >
              Download
            </button>
            <button
              id="shareBtn"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors hidden"
            >
              Share
            </button>
          </div>
        </div>
      </dialog>
    </main>

    <script>
      const form = document.getElementById("generatorForm");
      const input = document.getElementById("textInput");
      const qrContainer = document.getElementById("qrContainer");
      const clearButton = document.getElementById("clearButton");
      const submitBtn = document.getElementById("submitBtn");
      const qrModal = document.getElementById("qrModal");
      const closeModal = document.getElementById("closeModal");
      const modalContent = document.getElementById("modalContent");
      const downloadBtn = document.getElementById("downloadBtn");
      const shareBtn = document.getElementById("shareBtn");

      let currentQRData = null;
      let lastSubmitTime = 0;
      const minDelay = 1000;

      // Check if Web Share API is supported
      if (navigator.share) {
        shareBtn.classList.remove("hidden");
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();

        const now = Date.now();
        if (now - lastSubmitTime < minDelay) {
          alert("Please wait before generating another QR code");
          return;
        }
        lastSubmitTime = now;

        submitBtn.disabled = true;
        submitBtn.innerHTML =
          'Generating... <span class="text-xs ml-1 px-1.5 py-0.5 border border-white/30 rounded">ENTER</span>';

        const itemText = input.value;

        var typeNumber = 4;
        var errorCorrectionLevel = "L";
        var qr = qrcode(typeNumber, errorCorrectionLevel);
        qr.addData(itemText);
        qr.make();

        // Create QR item card
        const qrItem = document.createElement("div");
        qrItem.className =
          "bg-gray-800 rounded-lg shadow-xl p-4 flex flex-col sm:flex-row sm:items-center gap-4";

        // QR Image - Make it clickable
        const qrImg = document.createElement("div");
        qrImg.innerHTML = qr.createImgTag(3, 5);
        qrImg.className =
          "flex-shrink-0 mx-auto sm:mx-0 cursor-pointer hover:opacity-80 transition-opacity";
        qrImg.onclick = () => showModal(itemText, qr);

        // Content
        const qrContent = document.createElement("div");
        qrContent.className =
          "flex-1 break-words text-center sm:text-left text-gray-300";
        qrContent.textContent = itemText;

        // Actions
        const qrActions = document.createElement("div");
        qrActions.className =
          "flex flex-col sm:flex-row gap-2 sm:flex-shrink-0";

        const viewBtn = document.createElement("button");
        viewBtn.textContent = "View";
        viewBtn.className =
          "px-3 py-1.5 text-sm border border-blue-500 text-blue-400 hover:bg-blue-900/30 rounded-md transition-colors";
        viewBtn.onclick = () => showModal(itemText, qr);

        const downloadItemBtn = document.createElement("button");
        downloadItemBtn.textContent = "Download";
        downloadItemBtn.className =
          "px-3 py-1.5 text-sm border border-green-500 text-green-400 hover:bg-green-900/30 rounded-md transition-colors";
        downloadItemBtn.onclick = () => downloadQR(qr, itemText);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className =
          "px-3 py-1.5 text-sm border border-red-500 text-red-400 hover:bg-red-900/30 rounded-md transition-colors";
        deleteBtn.onclick = () => qrItem.remove();

        qrActions.appendChild(viewBtn);
        qrActions.appendChild(downloadItemBtn);
        qrActions.appendChild(deleteBtn);

        qrItem.appendChild(qrImg);
        qrItem.appendChild(qrContent);
        qrItem.appendChild(qrActions);

        qrContainer.insertBefore(qrItem, qrContainer.firstChild);

        // Select the text instead of clearing it
        input.select();

        // Auto-open modal after generation
        showModal(itemText, qr);

        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            'Generate <span class="text-xs ml-1 px-1.5 py-0.5 border border-white/30 rounded">ENTER</span>';
        }, 1000);
      });

      function showModal(text, qr) {
        modalContent.innerHTML = `
          <div class="flex flex-col items-center">
            ${qr.createImgTag(8, 20)}
            <p class="mt-4 text-gray-700 font-medium break-words text-center">${text}</p>
          </div>
        `;
        currentQRData = { text, qr };
        qrModal.showModal();
      }

      function downloadQR(qr, text) {
        const dataUrl = qr.createDataURL(8, 20);
        const link = document.createElement("a");
        link.download = `qrcode-${Date.now()}.png`;
        link.href = dataUrl;
        link.click();
      }

      closeModal.addEventListener("click", () => {
        qrModal.close();
      });

      downloadBtn.addEventListener("click", () => {
        if (!currentQRData) return;
        downloadQR(currentQRData.qr, currentQRData.text);
      });

      shareBtn.addEventListener("click", async () => {
        if (!currentQRData) return;

        try {
          // Convert QR code to blob
          const dataUrl = currentQRData.qr.createDataURL(8, 20);
          const response = await fetch(dataUrl);
          const blob = await response.blob();
          const file = new File([blob], `qrcode-${Date.now()}.png`, {
            type: "image/png",
          });

          await navigator.share({
            files: [file],
            title: "QR Code",
            text: currentQRData.text,
          });
        } catch (error) {
          // User cancelled or error occurred
          console.log("Share failed:", error);
        }
      });

      clearButton.addEventListener("click", () => {
        input.value = "";
      });
    </script>
  </body>
</html>
